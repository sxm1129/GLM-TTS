# Phoneme（音素）功能详解

## 功能概述

Phoneme（音素）功能是 GLM-TTS 中的**精细化发音控制机制**，主要用于解决中文文本到语音转换中的发音歧义问题。

## 核心作用

### 1. 解决多音字发音歧义

**问题场景**：
中文中存在大量多音字，同一个字在不同语境下读音不同，模型可能无法准确判断。

**典型例子**：
- **"行"** 字：
  - "行走" → 读作 `xíng`
  - "银行" → 读作 `háng`
  - "行业" → 读作 `háng`
  
- **"长"** 字：
  - "长度" → 读作 `cháng`
  - "成长" → 读作 `zhǎng`
  
- **"重"** 字：
  - "重要" → 读作 `zhòng`
  - "重复" → 读作 `chóng`

**Phoneme 解决方案**：
通过 G2P（文字到音素）转换，将多音字替换为明确的音素标记，确保模型使用正确的发音。

### 2. 解决生僻字发音问题

**问题场景**：
生僻字或罕见字可能不在模型的常见词汇表中，导致发音错误或无法发音。

**典型例子**：
- **"弦"** → 转换为音素 `<|X|><|IAN2|>`
- **"弈"** → 转换为音素 `<|I4|>`
- **"衰"**（在"鬓毛衰"中） → 转换为音素 `<|C|><|UEI1|>`

**Phoneme 解决方案**：
直接将生僻字转换为音素，绕过模型的词汇表限制，确保正确发音。

### 3. 提高发音准确性

**适用场景**：
- **教育评测**：需要准确的发音评分
- **有声读物**：特别是古典文学、专业术语
- **新闻播报**：人名、地名、专业名词
- **语音助手**：需要高准确度的场景

## 工作原理

### 工作流程

```
输入文本 → G2P转换 → 识别多音字/生僻字 → 音素替换 → 混合输入 → 模型推理
```

### 详细步骤

1. **G2P 转换（Grapheme-to-Phoneme）**
   - 将中文文字转换为拼音音素序列
   - 例如："你好" → `['n', '|', 'i', '-', 'h', '|', 'ao', '-']`

2. **动态识别**
   - 基于"动态可控词典"（`G2P_replace_dict.jsonl`）
   - 自动识别需要替换的多音字或生僻字

3. **混合输入（Hybrid Phoneme + Text）**
   - 将部分字符替换为音素标记
   - 保留其他字符为原文
   - 例如："银行" → "银<|H|><|ANG2|>"

4. **模型推理**
   - 模型接受混合输入（文字 + 音素）
   - 根据音素标记生成准确的发音

## 音素格式

### 音素标记格式

音素使用 `<|音素|>` 格式标记，例如：
- `<|X|>` - 声母 "x"
- `<|IAN2|>` - 韵母 "ian"，声调为 2（阳平）
- `<|I4|>` - 韵母 "i"，声调为 4（去声）

### 声调表示

- `1` - 阴平（第一声）
- `2` - 阳平（第二声）
- `3` - 上声（第三声）
- `4` - 去声（第四声）
- `5` - 轻声

## 配置示例

### G2P 替换字典示例

`configs/G2P_replace_dict.jsonl` 文件包含需要特殊处理的字符：

```json
{"弦": "<|X|><|IAN2|>"}
{"弈": "<|I4|>"}
{"乡音无改鬓毛衰": "乡音无改鬓毛<|C|><|UEI1|>"}
```

## 使用方法

### API 调用

```bash
curl -X POST http://localhost:8049/api/v1/tts \
  -F "input_text=银行" \
  -F "index=exampleA" \
  -F "use_phoneme=true"  # 启用音素功能
```

### 代码调用

```python
from tools.gradio_app import run_inference

result = run_inference(
    prompt_text="提示文本",
    prompt_audio_path="提示音频.wav",
    input_text="银行",  # 包含多音字
    use_phoneme=True,   # 启用音素功能
    ...
)
```

## 使用建议

### 何时启用 Phoneme

✅ **建议启用**：
- 文本包含多音字（如"银行"、"行走"、"重要"等）
- 文本包含生僻字或罕见字
- 需要高发音准确度的场景（教育、评测）
- 专业术语、人名、地名

❌ **可以不启用**：
- 标准日常对话文本
- 没有多音字的简单文本
- 对处理速度要求较高的场景

### 性能影响

- **处理时间**：启用后可能略微增加处理时间（需要 G2P 转换）
- **准确性**：显著提高多音字和生僻字的发音准确性
- **显存占用**：基本无影响

## 技术细节

### 混合训练机制

模型在训练时采用了**混合模态训练**：
- 对文本中的部分字词随机进行 G2P 转换
- 迫使模型适应混合输入序列
- 既保留对纯文本的理解能力，又增强对音素输入的泛化能力

### 对齐算法

系统使用对齐算法将音素序列与原始文本对齐：
- 自动识别哪些字符需要替换
- 保持文本的原始结构和韵律
- 只在必要时进行音素替换

## 实际效果

### 对比示例

**不使用 Phoneme**：
- "银行" → 可能读作 `yín xíng`（错误）
- "行走" → 可能读作 `háng zǒu`（错误）

**使用 Phoneme**：
- "银行" → 正确读作 `yín háng`
- "行走" → 正确读作 `xíng zǒu`

## 总结

Phoneme 功能是 GLM-TTS 中一个重要的**发音准确性增强功能**，通过音素级别的精确控制，解决了传统 TTS 系统在多音字和生僻字处理上的不足，特别适合对发音准确性要求较高的应用场景。

