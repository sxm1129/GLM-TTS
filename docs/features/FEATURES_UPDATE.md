# GLM-TTS Web界面功能更新说明

## ✅ 已集成的高级功能

### 1. **音素级别控制（Phoneme-in）** ✅

**功能描述**：
- 支持音素级别的文本到语音转换
- 解决多音字和生僻字的发音歧义问题
- 提高发音准确性，特别适用于教育评测、有声读物等场景

**使用方法**：
- 在"Advanced Settings"中勾选"启用音素控制 (Phoneme Control)"
- 启用后，模型会对文本进行G2P（文字到音素）转换
- 自动识别并处理多音字和生僻字

**注意事项**：
- 启用音素控制可能会略微增加处理时间
- 对于标准文本，可以不启用此功能

---

### 2. **采样方法选择** ✅

**功能描述**：
- 支持两种采样策略来控制生成质量

**选项说明**：
- **ras (Repetition-Aware Sampling)**：推荐选项
  - 智能处理重复token，避免重复生成
  - 适合大多数场景，生成质量稳定
  
- **topk (Top-K采样)**：
  - 传统的Top-K采样方法
  - 可以尝试不同的生成风格

**使用方法**：
- 在"Advanced Settings"中选择"采样方法 (Sampling Method)"
- 默认使用"ras"方法

---

### 3. **采样参数（Sampling/Top-K）** ✅

**功能描述**：
- 控制采样时的候选token数量
- 影响生成结果的多样性和质量

**参数范围**：1-100（默认：25）

**使用建议**：
- **较低值（10-25）**：生成更稳定、质量更高，但多样性较低
- **中等值（25-50）**：平衡质量和多样性
- **较高值（50-100）**：多样性更高，但可能降低质量

**使用方法**：
- 在"Advanced Settings"中调整"采样参数 (Sampling/Top-K)"滑块

---

### 4. **Beam Search（束搜索）** ✅

**功能描述**：
- 使用束搜索可以生成更高质量的语音
- 通过探索多个候选路径选择最佳结果

**参数范围**：1-5（默认：1）

**使用建议**：
- **Beam Size = 1**：不使用束搜索，速度最快，显存占用最少
- **Beam Size = 2-3**：推荐值，质量提升明显，速度可接受
- **Beam Size = 4-5**：最高质量，但计算时间和显存占用显著增加

**注意事项**：
- Beam Size > 1 会显著增加：
  - 计算时间（约2-5倍）
  - GPU显存占用（约2-5倍）
- 建议在显存充足时使用（L20 GPU可以支持）

**使用方法**：
- 在"Advanced Settings"中调整"Beam Size (束搜索)"滑块

---

## 📊 功能对比表

| 功能 | 默认值 | 影响 | 推荐场景 |
|------|--------|------|----------|
| **音素控制** | 关闭 | 提高发音准确性 | 多音字、生僻字较多的文本 |
| **采样方法** | ras | 影响生成风格 | ras适合大多数场景 |
| **采样参数** | 25 | 影响多样性 | 25-50平衡质量和多样性 |
| **Beam Size** | 1 | 影响质量和速度 | 2-3推荐，追求质量可用4-5 |

---

## 🎯 推荐配置

### 标准配置（快速生成）
- 音素控制：关闭
- 采样方法：ras
- 采样参数：25
- Beam Size：1

### 高质量配置（追求最佳质量）
- 音素控制：开启（如果有多音字）
- 采样方法：ras
- 采样参数：30-40
- Beam Size：3-4

### 多样性配置（需要不同风格）
- 音素控制：关闭
- 采样方法：topk
- 采样参数：50-70
- Beam Size：2

---

## 🔧 技术实现说明

### 代码修改
1. **模型缓存优化**：支持根据`use_phoneme`参数缓存不同模型
2. **参数传递**：所有高级参数正确传递到推理函数
3. **自定义LLM前向函数**：创建包装函数支持beam_size和sampling参数

### 文件修改
- `tools/gradio_app.py`：添加所有UI控件和参数处理逻辑

---

## ⚠️ 注意事项

1. **显存管理**：
   - Beam Size > 1 会增加显存占用
   - 如果显存不足，建议使用Beam Size = 1
   - 可以使用"Clear VRAM"按钮清理显存

2. **生成速度**：
   - 音素控制：略微增加处理时间
   - Beam Search：显著增加处理时间（2-5倍）
   - 采样参数：影响较小

3. **参数组合**：
   - 某些参数组合可能产生意外结果
   - 建议从默认配置开始，逐步调整

---

## 🚀 流式推理（待实现）

**状态**：暂未实现

**原因**：
- 流式推理需要修改核心生成函数
- 需要实现音频流式输出和播放
- 需要较大的代码改动

**计划**：
- 后续版本中实现流式推理功能
- 支持实时生成和播放音频

---

## 📝 更新日志

**2025-12-12**
- ✅ 集成音素级别控制功能
- ✅ 添加采样方法选择（ras/topk）
- ✅ 添加采样参数控制（1-100）
- ✅ 添加Beam Search支持（1-5）
- ✅ 优化模型缓存机制
- ✅ 更新UI界面，添加所有高级设置

---

## 📚 参考文档

- 项目README: `README.md` / `README_zh.md`
- 缺失功能分析: `MISSING_FEATURES.md`
- Web访问说明: `WEB_ACCESS.md`


